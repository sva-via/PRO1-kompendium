# Kapitel 13 – Refactoring og code smells (intro)

## 1. Introduktion

Selv med god intention og klart design opstår der over tid problemer i kode. Disse problemer viser sig ofte som code smells – tegn på, at designet bør forbedres.

Refactoring er disciplinen, hvor vi forbedrer den interne struktur i koden uden at ændre dens ydre adfærd.

## 2. Hvad er refactoring?

Refactoring betyder systematisk at forbedre kode, så den bliver mere læsbar, mere sammenhængende og lettere at vedligeholde – uden at ændre funktionalitet.

Refactoring kræver test. Uden test ved vi ikke, om vi har bevaret adfærden.

## 3. Duplication

Duplication opstår, når den samme logik findes flere steder i systemet.

```
public int daysInApril() {
    return 30;
}

public int daysInJune() {
    return 30;
}
```
Hvis reglen for antal dage ændres, skal den ændres flere steder. Det øger risikoen for fejl.

Løsning: Saml fælles logik ét sted og genbrug den.

## 4. Long method

En lang metode med mange ansvar er svær at forstå og teste.

```
public void processOrder(Order order) {

    // valider input
    if (order == null) {
        throw new IllegalArgumentException();
    }

    // beregn pris
    double total = 0;
    for (OrderLine line : order.getLines()) {
        total += line.getPrice();
    }

    // opdater lager
    // send bekræftelse
    // log aktivitet
}
```
Metoden udfører flere forskellige opgaver. Det reducerer cohesion.

Løsning: Opdel i mindre metoder med ét klart ansvar.

## 5. For mange ansvar

```
public class Account {

    private double balance;

    public void deposit(double amount) {
        balance += amount;
    }

    public void printStatement() {
        System.out.println(balance);
    }

    public void saveToDatabase() {
        // databasekode
    }
}
```
Her håndterer Account både domænelogik, præsentation og persistence. Det bryder princippet om ét ansvar.

Løsning: Adskil domæne, præsentation og infrastruktur.

## 6. Designovervejelser

Refactoring bør ske løbende – ikke først når systemet er uoverskueligt.

Code smells er ikke fejl i sig selv, men signaler om svagt design.

Test er forudsætningen for sikker refactoring.

## 7. Typiske fejl og misforståelser

1) At ændre funktionalitet under refactoring.
2) At ignorere duplication, fordi 'det virker'.
3) At acceptere lange metoder som nødvendige.
4) At undlade tests før refactoring.

## 8. Refleksionsspørgsmål

1) Hvorfor er duplication farligt i større systemer?
2) Hvornår er en metode for lang?
3) Hvordan hænger cohesion og refactoring sammen?

## 9. Små øvelser

Øvelse 1: Identificér duplication i en klasse, du tidligere har skrevet.

Øvelse 2: Opdel en lang metode i mindre metoder med tydelige navne.
